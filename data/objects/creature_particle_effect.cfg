{
	id: "creature_particle_effect",
	is_strict: true,
	hidden_in_game: true,

	properties: {
		_creature: { type: "obj creature" },


		lane_influence_particles: "def(bool going_up, [decimal,decimal,decimal] color) ->commands [
			set(me.particles, dump(lib.particles.create(me, {
				position: [0,0],
				particle_quota: 5000,
				texture: 'particles/flare-128x128.png',
				particle_width: lib.citadel.px(32),
				particle_height: lib.citadel.px(128),

				emitters: [
				{
					name: 'parent_emitter',
					type: 'circle',
					emits_type: 'emitter_particle',
					emits_name: 'flare_emitter',
					position: [0,0,0],
					emission_rate: 0.5,
					circle_radius: _creature.img_w/2,
					direction: [0, if(going_up, -1, 1), 0],
					time_to_live: 5.0,
					velocity: 0,
					color: color + [0.4],
					angle: 0.0,
				}, {
					name: 'flare_emitter',
					type: 'circle',
					position: [0,0,0],
					emission_rate: 5.0,
					circle_radius: lib.citadel.px(5),
					direction: [0, if(going_up, -1, 1), 0],
					time_to_live: distance_to_travel/50.0,
					velocity: lib.citadel.px(50),
					color: color + [0.1],
					angle: 5.0,
				}, {
					name: 'ambient_emitter',
					type: 'circle',
					position: [0,0,0],
					emission_rate: 30.0,
					circle_radius: lib.citadel.px(40),
					direction: [0, if(going_up, -1, 1), 0],
					time_to_live: distance_to_travel/50.0,
					velocity: lib.citadel.px(50),
					color: color + [0.1],
					angle: 5.0,
				},
				]

				where distance_to_travel = if(going_up, _creature.mid_y - top_tile_in_lane.y, bot_tile_in_lane.mid_y - _creature.mid_y)
				where top_tile_in_lane = obj tile<- choose(filter(level.chars, value is obj tile and value.loc[0] = _creature.creature_object.loc[0]), -value.y)
				where bot_tile_in_lane = obj tile<- choose(filter(level.chars, value is obj tile and value.loc[0] = _creature.creature_object.loc[0]), value.y),
				active_emitters: ['ambient_emitter', 'parent_emitter'],
				affectors: [{
					type: 'color',
					time_color: [{time: 0, color: color + [0]}, {time: 0.2, color: color + [0.1]}, {time: 0.8, color: color + [0.1]}, {time: 1, color: color + [0]}],

				}]
			}))
			)
		]",
	},

	on_create: "[
		add(_creature.particle_effects, [me]),
	]",


}
