{
	id: "login_controller",
	is_human: true,
	hitpoints: 20,
	editor_info: { category: "player" },
    hidden_in_level: true,
    use_absolute_screen_coordinates: true,
	zorder: 2000,

	is_strict: true,

	consts: {
		BUTTON_WIDTH: 220,
		BUTTON_HEIGHT: 35,
	},
	
    properties: {

		_client: { type: "object|null", default: null },

		font: "string<- 'RobotoCondensed-Regular'",
		font_color: "string<- 'antique_white'",

		level_width: "int<- level.dimensions[2]",
		level_height: "int<- level.dimensions[3]",

		_error_message: { default: "" },

		_progress_controller: { type: "obj progress_controller|null" },

		get_server_info: "commands<- [tbs_send(cl, {type: 'get_server_info'}), set(me._client, cl)] where cl = tbs_client(TBS_SERVER_ADDRESS, TBS_SERVER_PORT, -1)",

		register_account: "def() ->commands [
			set(_input_state, 'register'),
			fire_event('refresh'),
		]",

		starting_screen: "def() ->commands [
			set(_input_state, ''),
			fire_event('refresh'),
		]",

		play_offline: "def() ->commands [
			teleport('lobby.cfg', '', 'instant', playable)
		] where playable = object_playable('title_controller', 0, 0, 1, {
			_mm_client_state: construct('mm_client_state', {
				client: null,
				username: 'Player',
				session_id: -1,
			})
		})",

		login_account: "def() ->commands [
			set(_input_state, 'login'),
			fire_event('refresh'),
		]",

		do_auto_login: "def(string cookie) ->commands [
			set(_input_state, 'logging_in'),
			set(_client, cl),
			execute(me, tbs_send(cl, {
				type: 'auto_login',
				cookie: cookie,
			})),
		] where cl = tbs_client(TBS_SERVER_ADDRESS, TBS_SERVER_PORT)",

		do_login: "def() ->commands [
			set(_client, cl),
			execute(me, tbs_send(cl, {
				type: 'login',
				user: _username_entry.text,
				passwd: md5(_passwd_entry.text),
				remember: bool<- (object<- me.widgets.remember_me_checkbox).checked,
			})),
		] where cl = tbs_client(TBS_SERVER_ADDRESS, TBS_SERVER_PORT)",

		do_register: "def() ->commands
		if(_passwd_entry.text != _confirm_passwd_entry.text,
		[
			set(_error_message, 'Passwords do not match'),
			register_account(),
		],
		[
			debug(_username_entry.text, _passwd_entry.text),
			set(_client, cl),
			execute(me, tbs_send(cl, {
				type: 'register',
				user: _username_entry.text,
				passwd: md5(_passwd_entry.text),
				remember: bool<- (object<- me.widgets.remember_me_checkbox).checked,
			})),
		] where cl = tbs_client(TBS_SERVER_ADDRESS, TBS_SERVER_PORT))",

		complete_login: "def(int session_id, string username, string|null cookie) ->commands [
			write_document('citadel_cookie', if(cookie = null, null, {cookie: cookie})),
			teleport('lobby.cfg', '', 'instant', playable)
		] where playable = object_playable('title_controller', 0, 0, 1, {
			_mm_client_state: construct('mm_client_state', {
				client: tbs_client(TBS_SERVER_ADDRESS, TBS_SERVER_PORT, {
					session: session_id,
					id: 'matchmake'
				}),
				username: username,
				session_id: session_id,
			})
		})",

		_username_entry: "text_editor_widget<- widgets.username_entry",
		_passwd_entry: "text_editor_widget<- widgets.passwd_entry",
		_confirm_passwd_entry: "text_editor_widget<- widgets.confirm_passwd_entry",

		_input_state: { default: "" },

		display_widgets: "[map] ::
		switch(_input_state,

		'logging_in', [
			{type: 'label', id: 'log_in_label', font: font, size: 24, color: 'white', text: 'Logging in...'},
		],

		'login', [{
			type: 'grid',
			columns: 2,
			column_widths: 200,
			column_alignments: 'center',
			x: level_width/2 - 400,
			y: 60,
			children: [
			{type: 'label', font: font, size: 14, color: 'white', text: 'Username:'},
			{
				type: 'text_editor',
				id: 'username_entry',
				width: 200,
				font_size: 18,
				focus: true,
				on_tab: q([set(me._username_entry.has_focus, false), set(me._passwd_entry.has_focus, true)]),
				on_enter: q(me.do_login()),
			},

			{type: 'label', font: font, size: 14, color: 'white', text: 'Password:'},
			{
				type: 'text_editor',
				id: 'passwd_entry',
				password: true,
				width: 200,
				font_size: 18,
				on_enter: q(me.do_login()),
			},
			]
		},

		{type: 'label', font: font, size: 14, color: 'red', text: _error_message},

		{
			type: 'checkbox',
			id: 'remember_me_checkbox',
			x: level_width/2 - 150,
			y: 150,
			checked: true,
			label: {type: 'label', font: font, size: 14, color: 'white', text: 'Remember me'},
			hpad: 30,
			on_click: q(null),
		},

		{
			type: 'button',
			on_click: bind(me.do_login),
			x: level_width/2 - 150,
			y: 190,
			label: {type: 'label', font: font, size: 14, color: 'white', text: 'Login'},
		},
		
		],

		'register', [{
			type: 'grid',
			columns: 2,
			column_widths: 200,
			column_alignments: 'center',
			x: level_width/2 - 400,
			y: 60,
			children: [
			{type: 'label', font: font, size: 14, color: 'white', text: 'Username:'},
			{
				type: 'text_editor',
				id: 'username_entry',
				width: 200,
				font_size: 18,
				focus: true,
				on_tab: q([set(me._username_entry.has_focus, false), set(me._passwd_entry.has_focus, true)])
			},

			{type: 'label', font: font, size: 14, color: 'white', text: 'Password:'},
			{
				type: 'text_editor',
				id: 'passwd_entry',
				password: true,
				width: 200,
				font_size: 18,
				on_tab: q([set(me._passwd_entry.has_focus, false), set(me._confirm_passwd_entry.has_focus, true)])
			},

			{type: 'label', font: font, size: 14, color: 'white', text: 'Confirm Password:'},
			{
				type: 'text_editor',
				id: 'confirm_passwd_entry',
				password: true,
				width: 200,
				font_size: 18,
			},

			]
		},

		{type: 'label', font: font, size: 14, color: 'red', text: _error_message},

		{
			type: 'checkbox',
			id: 'remember_me_checkbox',
			x: level_width/2 - 150,
			y: 180,
			checked: true,
			label: {type: 'label', font: font, size: 14, color: 'white', text: 'Remember me'},
			hpad: 30,
			on_click: q(null),
		},

		{
			type: 'button',
			on_click: bind(me.do_register),
			x: level_width/2 - 150,
			y: 220,
			label: {type: 'label', font: font, size: 14, color: 'white', text: 'Create Account'},
		},
		
		],

		[{
			type: 'grid',
			columns: 1,
			column_widths: 300,
			column_alignments: 'center',
			x: ((12*level_width)/16 - 150)/2,
			y: 100,
			children: [{
				type: 'button',
				label: {type: 'label', font: font, size: 28, color: 'white', text: 'Create Account'},
				on_click: bind(me.register_account),
			},

			{
				type: 'button',
				on_click: bind(me.login_account),
				label: {type: 'label', font: font, size: 28, color: 'white', text: 'Login'},
			},

			{
				type: 'button',
				on_click: bind(me.play_offline),
				label: {type: 'label', font: font, size: 28, color: 'white', text: 'Play Offline'},
			},
			],
		}]
		)
		",
	},

    on_create: "[
		if(cookie!= null, do_auto_login(string<- cookie['cookie'])) where cookie = get_document('citadel_cookie', ['null_on_failure', 'user_preferences_dir']),
		fire_event('window_resize', {width: level.camera_position[2], height: level.camera_position[3]}),
	]",

	on_window_resize: "[
		set(level.dimensions, [0,0,arg.width,arg.height]),
		fire_event('refresh')
	]",
	
	on_refresh: "[
//		draw_menu(width, height), 

		set_widgets({
		type: 'dialog',
		id: 'background_dlg',
		background_alpha: 255,
		rect: [0, 0, level_width, level_height],
		children: [
			{ type: 'image', image: 'title2.png', image_width: 750, image_height:350, x: (level_width-750)/2, y: 20 },

			{
				type: 'dialog',
				id: 'dlg',
				background_frame: 'empty_window',
				background_alpha: 20,
				rect: [level_width/16, level_height/2+40, 14*level_width/16, level_height/2-50],
				cursor: [35, 20],

		
				children: display_widgets,
			},
		],
	}),
	]",
	
	on_process: "[
		if(me._client, tbs_process(me._client)),

		if(_progress_controller and need_progress = false, [
			set(_progress_controller, null),
			remove_object(_progress_controller),
		],

		if(_progress_controller = null and need_progress, [
			add_object(ctrl),
			set(_progress_controller, ctrl)
		] where ctrl = object('progress_controller', 0, 0, 1)))
		  where need_progress = (_input_state = 'logging_in')

	]",
    
    on_connection_error: "if(_input_state = 'logging_in',
	                         [
							 	schedule(50, fire_event('create')),
								set((label<- widgets.log_in_label).text, 'Trouble connecting to server. Retrying...'),
							 ],
	                         starting_screen())",
    
	on_connection_success: "debug('connected okay')",

	on_message_received: "[debug(message.type, message), switch(message.type,
		'login_fail', [
			set(_error_message, string<- message.message),
			login_account(),
		],
		'registration_fail', [
			set(_error_message, string<- message.message),
			register_account(),
		],
		'auto_login_fail', starting_screen(),
		'login_success', complete_login(int<- message.session_id, string<- message.username, string|null<- message.cookie),
		'registration_success', complete_login(int<- message.session_id, string<- message.username, string|null<- message.cookie),
		debug('UNKNOWN MESSAGE RECIEVED: ' + message.type)
	)] where message = map<- arg.message",
	
	on_enter_level: "[
//		draw_menu(SCREEN_WIDTH, SCREEN_HEIGHT), 
	]",
}
