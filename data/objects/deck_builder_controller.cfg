{
	id: "deck_builder_controller",
	next_animation: "'normal'",
	is_human: true,
	is_strict: true,
	always_active: true,
	hidden_in_game: true,

	vars: {
		state: null,
		
		font: 'RobotoCondensed-Regular',
		color: 'antique_white',
	},

	tmp: {
		// card_list is a map of card_name:card_widget_objects
		card_list: null,
		// filtered cards is purely a list of card_widget_objects
		filtered_cards: null,
		deck: null,
		
		show_blood_cards: true,
		show_faith_cards: true,
		show_food_cards: true,
		show_gold_cards: true,
		show_scrolls_cards: true,
		
		show_spell_cards: true,
		show_creature_cards: true,
		show_building_cards: true,
	},

	properties: {
		level_width: "level.dimensions[2]",
		level_height: "level.dimensions[3]",
		set_info_text: "def(txt) set(me.widgets.info_text.text, txt)",
		draw_cards: "set(get_widget(me, 'card_grid').children, tmp.filtered_cards)",
		
		build_card_widget: "widget(me, {
			type: 'object',
			object: 'card', 
			handle_process: true,
		})",
			
		draw_interface: "def(cards) set(me.widgets, [{
			type: 'dialog',
			id: 'cards_dlg',
			rect: [0, 0, 2*level_width/3, 2*level_height/3],
			background_alpha: 255,
			background_frame: 'empty_window',
			cursor: [10, 10],
			children: [{
				type: 'grid',
				columns: 5,
				children: [{
					type: 'button',
					wh: [35, 25],
					label: '|<',
					on_click: q(debug('clicked |< cards')),
				}, {
					type: 'button',
					wh: [35, 25],
					label: '>',
					on_click: q(debug('clicked > cards')),
				}, {
					type: 'button',
					wh: [35, 25],
					label: '>',
					on_click: q(debug('clicked > cards')),
				}, {
					type: 'button',
					wh: [35, 25],
					label: '>|',
					on_click: q(debug('clicked >| cards')),
				},{
					type: 'label',
					id: 'info_text',
					text: 'Number of cards selected ' + str(size(cards)),
					color: 'green',
					font: vars.font,
					size: 12,
				}]
			}, {
				type: 'grid',
				id: 'card_grid',
				columns: 3,
				column_width: cards[0].width,
				max_height: 2*level_width/3-30,
				children: cards,
			}],
		}, {
			type: 'dialog',
			id: 'selection_dlg',
			rect: [2*level_width/3, 0, level_width/3, 2*level_height/3],
			background_alpha: 255,
			background_frame: 'empty_window',
			cursor: [10, 10],
			children: [{
				type: 'grid',
				columns: 2,
				children: [{
					type: 'label',
					font: vars.font,
					color: vars.color,
					size: 16,
					text: 'Expression to filter with:',
				}, {
					type: 'text_editor', 
					id: 'filter_box',
					font_size: 16, 
					//font: vars.font,
					color: vars.color,
					width: 150, 
					height: 30,
					text: '',						
				}],
			}, {
				type: 'grid',
				columns: 1,
				children: [{
					type: 'grid',
					columns: 1,
					children: [{
						type: 'checkbox',
						text: {type: 'label', text:'Blood Cards', font: vars.font, color: vars.color, size: 14},
						checked: true,
						wh: [150, 30],
						on_click: 'set(me.tmp.show_blood_cards, checked)',
					}, {
						type: 'checkbox',
						text: {type: 'label', text:'Faith Cards', font: vars.font, color: vars.color, size: 14},
						checked: true,					
						wh: [150, 30],
						on_click: 'set(me.tmp.show_faith_cards, checked)',
					}, {
						type: 'checkbox',
						text: {type: 'label', text:'Food Cards', font: vars.font, color: vars.color, size: 14},
						checked: true,
						wh: [150, 30],
						on_click: 'set(me.tmp.show_food_cards, checked)',
					}, {
						type: 'checkbox',
						text: {type: 'label', text:'Gold Cards', font: vars.font, color: vars.color, size: 14},
						checked: true,
						wh: [150, 30],
						on_click: 'set(me.tmp.show_gold_cards, checked)',
					}, {
						type: 'checkbox',
						text: {type: 'label', text:'Scrolls Cards', font: vars.font, color: vars.color, size: 14},
						checked: true,
						wh: [150, 30],
						on_click: 'set(me.tmp.show_scrolls_cards, checked)',
					}],
				}, {
					type: 'grid',
					columns: 1,
					children: [{
						type: 'checkbox',
						text: {type: 'label', text:'Show Spells', font: vars.font, color: vars.color, size: 14},
						checked: true,
						wh: [150, 30],
						on_click: 'set(me.tmp.show_spell_cards, checked)',
					}, {
						type: 'checkbox',
						text: {type: 'label', text:'Show Buildings', font: vars.font, color: vars.color, size: 14},
						checked: true,
						wh: [150, 30],
						on_click: 'set(me.tmp.show_building_cards, checked)',
					}, {
						type: 'checkbox',
						text: {type: 'label', text:'Show Creatures', font: vars.font, color: vars.color, size: 14},
						checked: true,
						wh: [150, 30],
						on_click: 'set(me.tmp.show_creature_cards, checked)',
					}]
				}],
			}],
		}, {
			type: 'dialog',
			id: 'deck_dlg',
			rect: [0, 2*level_height/3, level_width, level_height/3],
			background_alpha: 255,
			background_frame: 'empty_window',
			children: [{
				type: 'button',
				label: '<',
				xy: [10, level_height/6-10],
				on_click: q(debug('clicked < hand')),
			}, {
				type: 'button',
				label: '>',
				xy: [2*level_width/3-40, level_height/6-10],
				on_click: q(debug('clicked > hand')),
			}],
		}])",
	},
	
	on_create: "[
		debug('on_create'),
		console_output_to_screen(false), 
		set(tmp.card_list, card_objs),
		set(tmp.filtered_cards, fxxf),
		map(card_objs, [
			set(value.object.card_type, construct('card', get_document('data/cards.cfg')[key])),
			set(value.object.mid_xy, [200, 200]),
			set(value.object.zorder, 1000),
		]),
		draw_interface(fxxf),
	] where fxxf = map(card_objs, value) where card_objs = fold(map(get_document('data/cards.cfg'), {(key):build_card_widget}), a+b)",
	
	on_window_resize: "[
		debug('resize'),
		set(level.dimensions, [0,0,new_width,new_height]),
		draw_interface(tmp.filtered_cards),
	] where new_width = max(width,800)-1
	  where new_height = max(height,480)-1
	",

	on_end_anim: "animation('normal')",
	zorder: 50,
	
	animation: {
		id: "normal",
		image: "effects/particles.png",
		x: 86,
		y: 73,
		w: 28,
		h: 28,
		collide: [0,0,28,28],
		frames: 1,
		duration: 1000,
	},
	
	editor_info: {
		category: "controllers",
		var: [
			{
				name: "x_bound",
				type: "x",
				value: "x-100",
			},
			{
				name: "x2_bound",
				type: "x",
				value: "x+150",
			},
			{
				name: "y_bound",
				type: "y",
				value: "y-100",
			},
			{
				name: "y2_bound",
				type: "y",
				value: "y+150",
			},
		],
	},
}