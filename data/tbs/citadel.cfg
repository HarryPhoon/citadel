{
	handlers: {
		start: "set(doc, construct('game',
		                 {
		         players: map(range(2),
				        construct('player',
				            {
								player_index: value,
							}
				          ))}))",

		add_bot: "[add(bots, [{
			script: [{
				session_id: session_id,
				send: {
					type: 'request_updates'
				}
			}],

			on_create: q(set(data, construct('bot', {session_id: ${session_id}}))),
			on_message: q(data.handle_message(message, me)),

		}]),
		debug('ADD BOT')]",

		message: "[debug('got message: ' + message.type),
		 //handle_errors(
		 switch(message.type,
		  'submit_deck',
		  [
		  set(doc.players, doc.players[:player] + [ new_player ] + doc.players[player+1:]),
		  doc.player_init(new_player)
		  ] where new_player =
		    construct('player',
			  {
				 player_index: player,
				 deck: shuffled_deck[5:],
				 hand: shuffled_deck[0:5]
			  } where shuffled_deck = shuffle(map(message.deck, value))
			),
		  'moves',
		  if(player = doc.current_player and message.state_id = state_id,
		     doc.process_moves(message))
		),
		 //error handling
		 /*
		 [
		   debug('ERROR WHILE PROCESSING MESSAGE: ' + context.message.type + ': ' + error_msg),
		   context.doc.log_message('Server encountered error when processing ' + message.type)
		 ]
		)
		*/ 
		 ]",

		transform: "[set(message.nplayer, nplayer)]",
	}
}
