{
	id: "matchmaking_base",

	properties: {
		_mm_client_state: { type: "class mm_client_state" },
		mm_client: "object|null :: _mm_client_state.client",

		selected_deck: { type: "string", default: "" },

		get_server_info: "commands<- if(mm_client != null, [tbs_send(mm_client, {type: 'get_server_info'})])",

		is_online: "bool :: mm_client != null",
	},

	timer_frequency: 5,

	on_timer: "if(mm_client != null, [
		if(mm_client.in_flight = 0, tbs_send(mm_client, {type: 'request_updates'})),
		tbs_process(mm_client),
	])",

	on_matchmake_connection_error: "teleport('titlescreen.cfg', '', 'instant', object_playable('login_controller', 0, 0, 0))",

	on_matchmake_message_received: "
	switch(message.type,
		'server_info', [
			if(message.bot_types, set(_mm_client_state.bot_types, [string]<- message.bot_types)),
		],
		'heartbeat', null,

		'matchmaking_queued', [
		],

		'match_made', [
    teleport('level1.cfg', '', 'fade',
  	object_playable('citadel_controller', 336, 372, 0, {
			_mm_client_state: _mm_client_state,
			game_server_address: if(message.host, string<- message.host, TBS_SERVER_ADDRESS),
			game_server_port: if(message.port, int<- message.port, TBS_SERVER_PORT),
			session_id: _mm_client_state.session_id,
			selected_deck: me.selected_deck,
			game_created: true,
			return_callback: (def(bool outcome) ->commands teleport('titlescreen.cfg', '', 'instant', object_playable('title_controller', 0, 0, 0, {
				_mm_client_state: _mm_client_state,
			})))
	}))
		],
	) asserting message.type != 'error'
	  where message = map<- arg.message",
}
